<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
        }
        .center {
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="center">
        <canvas id="canvas"></canvas>
    </div>

    <script>
        // variable globale
        let afficherObj;
        let dernierObjetClique;
        let ampouleEtat = [false, true, true, false];
        let lsAnimation = [];
        // init lsGraph
        let lsGraph = [];
        for (let i = 0; i < 4; i++) {
            lsGraph.push([]);
        }

        // définir le canvas
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        canvas.width = 1200;
        canvas.height = 700;

        // importer les images
        let images = {}
        let nbImage = 8;

        images.nuage = new Image();
        images.nuage.src = 'https://cdn.discordapp.com/attachments/624922182438617098/952600000481869854/cloud.png';
        images.nuage.width = 400;
        images.nuage.height = 300;

        images.alexa = new Image();
        images.alexa.src = 'https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fpluspng.com%2Fimg-png%2Famazon-alexa-png-getting-amazon-echo-s-alexa-to-notify-family-of-an-emergency-using-ifttt-1000.png&f=1&nofb=1';
        images.alexa.width = 100;
        images.alexa.height = 100;

        images.wifi = new Image();
        images.wifi.src = 'https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fst4.depositphotos.com%2F1003549%2F23285%2Fv%2F450%2Fdepositphotos_232854200-stock-illustration-wifi-symbol-icon-blue-simple.jpg&f=1&nofb=1';
        images.wifi.width = 100;
        images.wifi.height = 90;

        images.iphone = new Image();
        images.iphone.src = 'https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fpurepng.com%2Fpublic%2Fuploads%2Flarge%2Fpurepng.com-apple-iphone-xappleapple-iphonephonesmartphonemobile-devicetouch-screeniphone-xiphone-10electronicsobjects-2515306895701eqxj.png&f=1&nofb=1';
        images.iphone.width = 100;
        images.iphone.height = 100;

        images.prise = new Image();
        images.prise.src = 'https://cdn.discordapp.com/attachments/624922182438617098/948631964372578334/plug.png';
        images.prise.width = 100;
        images.prise.height = 100;

        images.priseGr = new Image();
        images.priseGr.src = 'https://cdn.discordapp.com/attachments/624922182438617098/948614868838269009/plugGr.png';
        images.priseGr.width = 100;
        images.priseGr.height = 100;

        images.ampouleOff = new Image();
        images.ampouleOff.src = 'ampouleOff.svg';
        images.ampouleOff.width = 100;
        images.ampouleOff.height = 100;

        images.ampouleOn = new Image();
        images.ampouleOn.src = 'ampouleOn.svg';
        images.ampouleOn.width = 100;
        images.ampouleOn.height = 100;

        // définir les positions
        lsPos = {
            iphone: {
                x: canvas.width * 0.1,
                y: canvas.height * 0.3,
            },
            alexa: {
                x: canvas.width * 0.1,
                y: canvas.height * 0.7,
            },
            nuage: {
                x: canvas.width * 0.3,
                y: canvas.height * 0.5,
            },
            prise1: {
                x: canvas.width * 0.55,
                y: canvas.height * 0.2,
            },
            prise2: {
                x: canvas.width * 0.55,
                y: canvas.height * 0.4,
            },
            prise3: {
                x: canvas.width * 0.55,
                y: canvas.height * 0.6,
            },
            prise4: {
                x: canvas.width * 0.55,
                y: canvas.height * 0.8,
            },
        }

        // afficher les objets graphique
        afficherObj = () => {
            // connexions
            lsAnimation.forEach(animation => {
                if (animation.etat == undefined) {
                    animation.etat = "créé";
                    animation.longeurConnexion = 0;
                }
                
                if (animation.etat == "créé" || animation.etat == "envoyé" || animation.etat == "pause" || animation.etat == "recevoi") {
                    if (animation.etat == "créé") animation.longeurConnexion++;

                    ctx.setLineDash([animation.longeurConnexion, canvas.width]);
                    ctx.lineDashOffset = 0;
                    ctx.strokeStyle = "#000";
                    ctx.lineWidth = 1;

                    ctx.beginPath();
                    ctx.moveTo(lsPos[animation.obj1].x, lsPos[animation.obj1].y);
                    ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[animation.obj2].x, lsPos[animation.obj2].y);
                    ctx.stroke();

                    if (animation.longeurConnexion >= canvas.width && animation.etat == "créé") {
                        animation.etat = "envoyé";
                        animation.dataOffset = 0;
                    }
                }

                if (animation.etat == "envoyé") {
                    ctx.setLineDash([4, 20]);
                    ctx.lineDashOffset = -animation.dataOffset;
                    ctx.strokeStyle = "#F00";
                    ctx.lineWidth = 4;

                    ctx.beginPath();
                    ctx.moveTo(lsPos[animation.obj1].x, lsPos[animation.obj1].y);
                    ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[animation.obj2].x, lsPos[animation.obj2].y);
                    ctx.stroke();

                    animation.dataOffset++;

                    if (animation.dataOffset >= canvas.width) {
                        animation.etat = "pause";
                        animation.finPause = Date.now() + 1000;
                    }
                }

                if (animation.etat == "pause") {
                    if (animation.finPause <= Date.now()) {
                        if (animation.action == "lumiere") {
                            // changer l'etat de l'ampoule
                            ampouleEtat[animation.obj2[5] - 1] = !ampouleEtat[animation.obj2[5] - 1];
                            animation.etat = "fermé";
                        }
                        else if (animation.action == "conso") {
                            animation.etat = "recevoi";
                        }
                    }
                }

                if (animation.etat == "recevoi") {
                    ctx.setLineDash([4, 20]);
                    ctx.lineDashOffset = -animation.dataOffset;
                    ctx.strokeStyle = "#F00";
                    ctx.lineWidth = 4;

                    ctx.beginPath();
                    ctx.moveTo(lsPos[animation.obj1].x, lsPos[animation.obj1].y);
                    ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[animation.obj2].x, lsPos[animation.obj2].y);
                    ctx.stroke();

                    animation.dataOffset--;

                    if (animation.dataOffset <= 0) {
                        animation.etat = "fermé";
                    }
                }

                if (animation.etat == "fermé") {
                    animation.longeurConnexion--;

                    ctx.setLineDash([animation.longeurConnexion, canvas.width]);
                    ctx.lineDashOffset = 0;
                    ctx.strokeStyle = "#000";
                    ctx.lineWidth = 1;

                    ctx.beginPath();
                    ctx.moveTo(lsPos[animation.obj1].x, lsPos[animation.obj1].y);
                    ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[animation.obj2].x, lsPos[animation.obj2].y);
                    ctx.stroke();

                    if (animation.longeurConnexion <= 0) {
                        animation.etat = "fin";
                    }
                }
            });

            // iphone
            let objet = "iphone";
            let img = images[objet];
            let pos = lsPos[objet];
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            // alexa
            objet = "alexa";
            img = images[objet];
            pos = lsPos[objet];
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            // réseau
            objet = "nuage";
            img = images[objet];
            pos = lsPos[objet];
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            objet = "wifi";
            img = images[objet];
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            // prise 1
            img = images.prise;
            pos = lsPos.prise1;
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);
            
            if (ampouleEtat[0]) img = images.ampouleOn;
            else img = images.ampouleOff;
            ctx.drawImage(img, pos.x - img.width / 1.7 + img.width, pos.y - img.height / 2, img.width, img.height);

            ctx.fillStyle = "#000";
            ctx.fillRect(pos.x + img.width + img.width, pos.y - img.height / 2, canvas.width / 5, img.height);

            // prise 2
            img = images.priseGr;
            pos = lsPos.prise2;
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            if (ampouleEtat[1]) img = images.ampouleOn;
            else img = images.ampouleOff;
            ctx.drawImage(img, pos.x - img.width / 1.7 + img.width, pos.y - img.height / 2, img.width, img.height);

            // prise 3
            img = images.priseGr;
            pos = lsPos.prise3;
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            if (ampouleEtat[2]) img = images.ampouleOn;
            else img = images.ampouleOff;
            ctx.drawImage(img, pos.x - img.width / 1.7 + img.width, pos.y - img.height / 2, img.width, img.height);

            // prise 4
            img = images.prise;
            pos = lsPos.prise4;
            ctx.drawImage(img, pos.x - img.width / 2, pos.y - img.height / 2, img.width, img.height);

            if (ampouleEtat[3]) img = images.ampouleOn;
            else img = images.ampouleOff;
            ctx.drawImage(img, pos.x - img.width / 1.7 + img.width, pos.y - img.height / 2, img.width, img.height);
        }

        // animation
        setInterval(() => {
            ctx.fillStyle = "#FFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            afficherObj();
        }, 1);

        setInterval(() => {
            ampouleEtat[3] = !ampouleEtat[3];
        }, 5000);

        setInterval(() => {
            lsGraph.forEach((graph, i) => {
                graph.push(ampouleEtat[i]);
            });
        }, 200);

        let startAnimation = (obj1, obj2) => {

            
            // let longeurConnexion = 0;
            // let intervalId = setInterval(() => {
            //     longeurConnexion++;

            //     effacer();

            //     ctx.setLineDash([longeurConnexion, canvas.width]);
            //     ctx.lineDashOffset = 0;

            //     ctx.beginPath();
            //     ctx.moveTo(lsPos[obj1].x, lsPos[obj1].y);
            //     ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[obj2].x, lsPos[obj2].y);
            //     ctx.stroke();

            //     if (longeurConnexion >= canvas.width) {
            //         clearInterval(intervalId);
            //         // commencer l'animation suivante
            //         let dataOffset = 0;
            //         let offset = 1;
            //         intervalId = setInterval(() => {
            //             effacer();

            //             ctx.setLineDash([longeurConnexion, canvas.width]);
            //             ctx.lineDashOffset = 0;
            //             ctx.strokeStyle = "#000";
            //             ctx.lineWidth = 1;

            //             ctx.beginPath();
            //             ctx.moveTo(lsPos[obj1].x, lsPos[obj1].y);
            //             ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[obj2].x, lsPos[obj2].y);
            //             ctx.stroke();

            //             ctx.setLineDash([4, 20]);
            //             ctx.lineDashOffset = -dataOffset;
            //             ctx.strokeStyle = "#F00";
            //             ctx.lineWidth = 4;

            //             ctx.beginPath();
            //             ctx.moveTo(lsPos[obj1].x, lsPos[obj1].y);
            //             ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[obj2].x, lsPos[obj2].y);
            //             ctx.stroke();

            //             dataOffset += offset;

            //             if (dataOffset >= canvas.width) {
            //                 if (obj1 == "alexa") {
            //                     clearInterval(intervalId);
            //                 }
            //                 else {
            //                     let date = Date.now() + 1000
            //                     while (Date.now() < date) {
            //                     }
            //                     offset = -1;
            //                 }
            //             }
            //             else if (dataOffset < 0) {
            //                 clearInterval(intervalId);
            //                 intervalId = setInterval(() => {
            //                     longeurConnexion--;

            //                     effacer();

            //                     ctx.setLineDash([longeurConnexion, canvas.width]);
            //                     ctx.lineDashOffset = 0;
            //                     ctx.strokeStyle = "#000";
            //                     ctx.lineWidth = 1;

            //                     ctx.beginPath();
            //                     ctx.moveTo(lsPos[obj1].x, lsPos[obj1].y);
            //                     ctx.quadraticCurveTo(lsPos["nuage"].x, lsPos["nuage"].y, lsPos[obj2].x, lsPos[obj2].y);
            //                     ctx.stroke();

            //                     if (longeurConnexion <= 0) {
            //                         clearInterval(intervalId);
            //                     }
            //                 }, 1);
            //             }
            //         }, 1);
            //     }
            // }, 1);
        }

        // activer l'interaction
        canvas.addEventListener("click", evt => {
            // iphone est cliqué
            if (
                (evt.offsetX > lsPos.iphone.x - images.iphone.width / 2 && evt.offsetX < lsPos.iphone.x + images.iphone.width / 2) &&
                (evt.offsetY > lsPos.iphone.y - images.iphone.height / 2 && evt.offsetY < lsPos.iphone.y + images.iphone.height / 2)
            ) {
                dernierObjetClique = "iphone";
            }
            // alexa est cliqué
            else if (
                (evt.offsetX > lsPos.alexa.x - images.alexa.width / 2 && evt.offsetX < lsPos.alexa.x + images.alexa.width / 2) &&
                (evt.offsetY > lsPos.alexa.y - images.alexa.height / 2 && evt.offsetY < lsPos.alexa.y + images.alexa.height / 2)
            ) {
                dernierObjetClique = "alexa";
            }

            // prise 1 est cliqué
            else if (
                (evt.offsetX > lsPos.prise1.x - images.prise.width / 2 && evt.offsetX < lsPos.prise1.x + images.prise.width / 2) &&
                (evt.offsetY > lsPos.prise1.y - images.prise.height / 2 && evt.offsetY < lsPos.prise1.y + images.prise.height / 2)
            ) {
                if (dernierObjetClique == "iphone") {
                    lsAnimation.push({
                        obj1: dernierObjetClique,
                        obj2: "prise1",
                        action: "conso",
                    });
                }
                else if (dernierObjetClique == "alexa") {
                    lsAnimation.push({
                        obj1: dernierObjetClique,
                        obj2: "prise1",
                        action: "lumiere",
                    });
                }

                dernierObjetClique = "prise1";
            }
            // prise groupe est cliqué
            else if (
                (evt.offsetX > lsPos.prise2.x - images.prise.width / 2 && evt.offsetX < lsPos.prise2.x + images.prise.width / 2) &&
                (evt.offsetY > lsPos.prise2.y - images.prise.height / 2 && evt.offsetY < lsPos.prise3.y + images.prise.height / 2)
            ) {
                if (dernierObjetClique == "iphone") {
                    lsAnimation.push({
                        obj1: dernierObjetClique,
                        obj2: "prise2",
                        action: "conso",
                    });
                    lsAnimation.push({
                        obj1: dernierObjetClique,
                        obj2: "prise3",
                        action: "conso",
                    });
                }
                else if (dernierObjetClique == "alexa") {
                    lsAnimation.push({
                        obj1: dernierObjetClique,
                        obj2: "prise2",
                        action: "lumiere",
                    });
                    lsAnimation.push({
                        obj1: dernierObjetClique,
                        obj2: "prise3",
                        action: "lumiere",
                    });
                }

                dernierObjetClique = "priseGr";
            }

            // ampoule 1 est cliqué
            else if (
                (evt.offsetX > lsPos.prise1.x + images.prise.width / 2) &&
                (evt.offsetY > lsPos.prise1.y - images.prise.height / 2 && evt.offsetY < lsPos.prise1.y + images.prise.height / 2)
            ) {
                lsAnimation.push({
                    obj1: dernierObjetClique,
                    obj2: "prise1",
                    action: "lumiere",
                });

                dernierObjetClique = "ampoule1";
            }
            // ampoule groupe est cliqué
            else if (
                (evt.offsetX > lsPos.prise2.x + images.prise.width / 2) &&
                (evt.offsetY > lsPos.prise2.y - images.prise.height / 2 && evt.offsetY < lsPos.prise3.y + images.prise.height / 2)
            ) {
                lsAnimation.push({
                    obj1: dernierObjetClique,
                    obj2: "prise2",
                    action: "lumiere",
                });
                lsAnimation.push({
                    obj1: dernierObjetClique,
                    obj2: "prise3",
                    action: "lumiere",
                });

                dernierObjetClique = "ampouleGr";
            }

            else {
                dernierObjetClique = "rien";
            }
        });
    </script>
</body>
</html>